<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Entity Framework 中 DbSet.Attach(entity) 跟 DbContext.Entry(entity).State = EntityState.Modified 的区别"><meta name="keywords" content=""><meta name="author" content="Orches Adam"><meta name="copyright" content="Orches Adam"><title>Entity Framework 中 DbSet.Attach(entity) 跟 DbContext.Entry(entity).State = EntityState.Modified 的区别 | Orches's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#DbSet-Attach-entity-vs-DbContext-Entry-entity-State-EntityState-Modified"><span class="toc-number">1.</span> <span class="toc-text">DbSet.Attach(entity) vs DbContext.Entry(entity).State = EntityState.Modified</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Code-example"><span class="toc-number">1.1.</span> <span class="toc-text">Code example</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Orches Adam</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">5</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Orches's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Entity Framework 中 DbSet.Attach(entity) 跟 DbContext.Entry(entity).State = EntityState.Modified 的区别</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-04-02</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h4 id="DbSet-Attach-entity-vs-DbContext-Entry-entity-State-EntityState-Modified"><a href="#DbSet-Attach-entity-vs-DbContext-Entry-entity-State-EntityState-Modified" class="headerlink" title="DbSet.Attach(entity) vs DbContext.Entry(entity).State = EntityState.Modified"></a>DbSet.Attach(entity) vs DbContext.Entry(entity).State = EntityState.Modified</h4><p>&emsp;&emsp;When you do context.Entry(entity).State = EntityState.Modified;, you are not only attaching the entity to the DbContext, you are also marking the whole entity as dirty. This means that when you do context.SaveChanges(), EF will generate an update statement that will update all the fields of the entity.</p>

<p>&emsp;&emsp;This is not always desired.</p>

<p>&emsp;&emsp;On the other hand, DbSet.Attach(entity) attaches the entity to the context without marking it dirty. It is equivalent to doing context.Entry(entity).State = EntityState.Unchanged;</p>

<p>&emsp;&emsp;When attaching this way, unless you then proceed to update a property on the entity, the next time you call context.SaveChanges(), EF will not generate a database update for this entity.</p>

<p></p><p>&emsp;&emsp;Even if you are planning on making an update to an entity, if the entity has a lot of properties (db columns) but you only want to update a few, you may find it advantageous to do a DbSet.Attach(entity), and then only update the few properties that need updating. Doing it this way will generate a more efficient update statement from EF. EF will only update the properties you modified (in contrast to context.Entry(entity).State = EntityState.Modified; which will cause all properties/columns to be updated)</p>
<p>Relevant documentation: <a href="https://msdn.microsoft.com/en-us/data/jj592676" target="_blank" rel="noopener">Add/Attach and Entity States.</a></p>
<h5 id="Code-example"><a href="#Code-example" class="headerlink" title="Code example"></a>Code example</h5><p>Let’s say you have the following entity:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class Person</span><br><span class="line">&#123;</span><br><span class="line">    public int Id &#123; get; set; &#125; // primary key</span><br><span class="line">    public string FirstName &#123; get; set; &#125;</span><br><span class="line">    public string LastName &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>If your code looks like this:</p>
<p>context.Entry(personEntity).State = EntityState.Modified;<br>context.SaveChanges();<br>The SQL generated will look something like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UPDATE person</span><br><span class="line">SET FirstName = &apos;whatever first name is&apos;,</span><br><span class="line">    LastName = &apos;whatever last name is&apos;</span><br><span class="line">WHERE Id = 123; -- whatever Id is.</span><br></pre></td></tr></table></figure>
<p>Notice how the above update statement will update all the columns, regardless or whether you’ve actually changed the values or not.</p>
<p>In contrast, if your code uses the “normal” Attach like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">context.People.Attach(personEntity); // State = Unchanged</span><br><span class="line">personEntity.FirstName = &quot;John&quot;; // State = Modified, and only the FirstName property is dirty.</span><br><span class="line">context.SaveChanges();</span><br></pre></td></tr></table></figure></p>
<p>Then the generated update statement is different:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE person</span><br><span class="line">SET FirstName = &apos;John&apos;</span><br><span class="line">WHERE Id = 123; -- whatever Id is.</span><br></pre></td></tr></table></figure></p>
<p>As you can see, the update statement only updates the values that were actually changed after you attached the entity to the context. Depending on the structure of your table, this can have a positive performance impact.</p>
<p>Now, which option is better for you depends entirely on what you are trying to do.</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Orches Adam</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/04/02/EF_Attach_Vs_Entry_State/">http://yoursite.com/2018/04/02/EF_Attach_Vs_Entry_State/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">Orches's Blog</a>！</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/04/02/C-Basic/"><i class="fa fa-chevron-left">  </i><span>C#_Basic</span></a></div><div class="next-post pull-right"><a href="/2018/04/02/Use_Core_Frst_When_Aleardy_Had_Database/"><span>EntityFramework core ,当数据库存在时，使用Code First</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2019 By Orches Adam</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>